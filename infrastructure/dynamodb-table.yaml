apiVersion: v1
kind: ConfigMap
metadata:
  name: aws-infrastructure-config
  namespace: encendido-eks
data:
  create-infrastructure.sh: |
    #!/bin/bash
    
    # Script para crear/verificar infraestructura AWS faltante
    # Trabaja con la infraestructura existente del proyecto
    
    set -e
    
    AWS_REGION=${AWS_REGION:-us-east-1}
    ENVIRONMENT=${ENVIRONMENT:-prod}
    ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
    
    echo "ðŸ”§ Configurando infraestructura AWS para namespace-startup-scheduler..."
    echo "   RegiÃ³n: ${AWS_REGION}"
    echo "   Cuenta: ${ACCOUNT_ID}"
    echo "   Entorno: ${ENVIRONMENT}"
    
    # 1. Verificar/actualizar tabla DynamoDB existente
    echo "ðŸ“Š Verificando tabla DynamoDB..."
    
    TABLE_NAME="NamespaceSchedules"
    
    # Verificar si la tabla existe
    if aws dynamodb describe-table --table-name "${TABLE_NAME}" --region "${AWS_REGION}" >/dev/null 2>&1; then
        echo "âœ… Tabla ${TABLE_NAME} ya existe"
        
        # Verificar si el GSI existe
        GSI_EXISTS=$(aws dynamodb describe-table --table-name "${TABLE_NAME}" --region "${AWS_REGION}" \
            --query 'Table.GlobalSecondaryIndexes[?IndexName==`estado-fecha_encendido-index`].IndexName' \
            --output text)
        
        if [ -z "$GSI_EXISTS" ]; then
            echo "ðŸ“ Creando GSI estado-fecha_encendido-index..."
            aws dynamodb update-table \
                --table-name "${TABLE_NAME}" \
                --region "${AWS_REGION}" \
                --attribute-definitions \
                    AttributeName=estado,AttributeType=S \
                    AttributeName=fecha_encendido,AttributeType=S \
                --global-secondary-index-updates \
                    'Create={
                        IndexName=estado-fecha_encendido-index,
                        KeySchema=[
                            {AttributeName=estado,KeyType=HASH},
                            {AttributeName=fecha_encendido,KeyType=RANGE}
                        ],
                        Projection={ProjectionType=ALL},
                        BillingMode=PAY_PER_REQUEST
                    }'
            
            echo "â³ Esperando que el GSI estÃ© disponible..."
            aws dynamodb wait table-exists --table-name "${TABLE_NAME}" --region "${AWS_REGION}"
            echo "âœ… GSI creado exitosamente"
        else
            echo "âœ… GSI estado-fecha_encendido-index ya existe"
        fi
    else
        echo "ðŸ“ Creando tabla ${TABLE_NAME}..."
        aws dynamodb create-table \
            --table-name "${TABLE_NAME}" \
            --region "${AWS_REGION}" \
            --attribute-definitions \
                AttributeName=id,AttributeType=S \
                AttributeName=estado,AttributeType=S \
                AttributeName=fecha_encendido,AttributeType=S \
            --key-schema \
                AttributeName=id,KeyType=HASH \
            --global-secondary-indexes \
                'IndexName=estado-fecha_encendido-index,
                KeySchema=[
                    {AttributeName=estado,KeyType=HASH},
                    {AttributeName=fecha_encendido,KeyType=RANGE}
                ],
                Projection={ProjectionType=ALL},
                BillingMode=PAY_PER_REQUEST' \
            --billing-mode PAY_PER_REQUEST \
            --tags \
                Key=Environment,Value="${ENVIRONMENT}" \
                Key=Project,Value=namespace-scheduler \
                Key=Component,Value=database
        
        echo "â³ Esperando que la tabla estÃ© disponible..."
        aws dynamodb wait table-exists --table-name "${TABLE_NAME}" --region "${AWS_REGION}"
        echo "âœ… Tabla creada exitosamente"
    fi
    
    # 2. Crear bucket S3 para configuraciÃ³n
    echo "ðŸª£ Configurando bucket S3..."
    
    BUCKET_NAME="namespace-scheduler-config-${ENVIRONMENT}-${ACCOUNT_ID}"
    
    if aws s3api head-bucket --bucket "${BUCKET_NAME}" --region "${AWS_REGION}" >/dev/null 2>&1; then
        echo "âœ… Bucket ${BUCKET_NAME} ya existe"
    else
        echo "ðŸ“ Creando bucket ${BUCKET_NAME}..."
        
        if [ "${AWS_REGION}" = "us-east-1" ]; then
            aws s3api create-bucket --bucket "${BUCKET_NAME}" --region "${AWS_REGION}"
        else
            aws s3api create-bucket \
                --bucket "${BUCKET_NAME}" \
                --region "${AWS_REGION}" \
                --create-bucket-configuration LocationConstraint="${AWS_REGION}"
        fi
        
        # Configurar encriptaciÃ³n
        aws s3api put-bucket-encryption \
            --bucket "${BUCKET_NAME}" \
            --server-side-encryption-configuration \
            'Rules=[{ApplyServerSideEncryptionByDefault={SSEAlgorithm=AES256}}]'
        
        # Bloquear acceso pÃºblico
        aws s3api put-public-access-block \
            --bucket "${BUCKET_NAME}" \
            --public-access-block-configuration \
            'BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true'
        
        # Habilitar versionado
        aws s3api put-bucket-versioning \
            --bucket "${BUCKET_NAME}" \
            --versioning-configuration Status=Enabled
        
        echo "âœ… Bucket creado y configurado exitosamente"
    fi
    
    # 3. Crear archivo de configuraciÃ³n inicial
    echo "ðŸ“„ Creando archivo de configuraciÃ³n inicial..."
    
    cat > /tmp/config.json << 'EOF'
    {
      "namespace-centros": {
        "production-app": ["CC001", "CC002", "CC003"],
        "staging-app": ["CC001", "CC002"],
        "development-app": ["CC001"],
        "testing-app": ["CC001", "CC002"],
        "demo-app": ["CC003"],
        "analytics": ["CC003", "CC004"],
        "monitoring": ["CC001", "CC005"],
        "data-processing": ["CC002", "CC004"],
        "ml-training": ["CC004", "CC005"],
        "backup-services": ["CC001"]
      },
      "configuracion": {
        "version": "1.0",
        "ultima_actualizacion": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
        "descripcion": "ConfiguraciÃ³n de centros de costo por namespace para sistema MVP",
        "validacion": {
          "centros_costo_validos": ["CC001", "CC002", "CC003", "CC004", "CC005"],
          "limite_namespaces": 5,
          "horario_minimo_encendido": "08:00",
          "horario_maximo_apagado": "03:00"
        }
      }
    }
    EOF
    
    # Reemplazar la fecha en el archivo
    sed -i "s/\$(date -u +%Y-%m-%dT%H:%M:%SZ)/$(date -u +%Y-%m-%dT%H:%M:%SZ)/" /tmp/config.json
    
    # Subir archivo a S3
    aws s3 cp /tmp/config.json "s3://${BUCKET_NAME}/config.json" --region "${AWS_REGION}"
    rm /tmp/config.json
    
    echo "âœ… Archivo de configuraciÃ³n creado en S3"
    
    # 4. Verificar/actualizar permisos IAM
    echo "ðŸ” Verificando permisos IAM..."
    
    ROLE_NAME="NamespaceControllerRole"
    
    if aws iam get-role --role-name "${ROLE_NAME}" >/dev/null 2>&1; then
        echo "âœ… Rol ${ROLE_NAME} ya existe"
        
        # Verificar si tiene permisos para S3
        S3_POLICY_EXISTS=$(aws iam list-attached-role-policies --role-name "${ROLE_NAME}" \
            --query 'AttachedPolicies[?PolicyName==`NamespaceControllerS3Policy`].PolicyName' \
            --output text)
        
        if [ -z "$S3_POLICY_EXISTS" ]; then
            echo "ðŸ“ Agregando permisos S3 al rol..."
            
            # Crear polÃ­tica para S3
            cat > /tmp/s3-policy.json << EOF
    {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Effect": "Allow",
                "Action": [
                    "s3:GetObject",
                    "s3:PutObject"
                ],
                "Resource": "arn:aws:s3:::${BUCKET_NAME}/config.json"
            },
            {
                "Effect": "Allow",
                "Action": [
                    "s3:ListBucket"
                ],
                "Resource": "arn:aws:s3:::${BUCKET_NAME}"
            }
        ]
    }
    EOF
            
            # Crear la polÃ­tica
            aws iam create-policy \
                --policy-name "NamespaceControllerS3Policy" \
                --policy-document file:///tmp/s3-policy.json \
                --description "Permisos S3 para el controlador de namespaces"
            
            # Adjuntar la polÃ­tica al rol
            aws iam attach-role-policy \
                --role-name "${ROLE_NAME}" \
                --policy-arn "arn:aws:iam::${ACCOUNT_ID}:policy/NamespaceControllerS3Policy"
            
            rm /tmp/s3-policy.json
            echo "âœ… Permisos S3 agregados al rol"
        else
            echo "âœ… Permisos S3 ya configurados"
        fi
        
        # Verificar permisos DynamoDB GSI
        DYNAMODB_POLICY_EXISTS=$(aws iam list-attached-role-policies --role-name "${ROLE_NAME}" \
            --query 'AttachedPolicies[?contains(PolicyName, `DynamoDB`)].PolicyName' \
            --output text)
        
        if [ -n "$DYNAMODB_POLICY_EXISTS" ]; then
            echo "âœ… Permisos DynamoDB ya configurados"
        else
            echo "âš ï¸  Verificar permisos DynamoDB manualmente"
        fi
    else
        echo "âš ï¸  Rol ${ROLE_NAME} no existe - debe crearse manualmente"
    fi
    
    # 5. Mostrar resumen
    echo ""
    echo "ðŸŽ‰ ConfiguraciÃ³n de infraestructura completada!"
    echo ""
    echo "ðŸ“‹ Resumen:"
    echo "   âœ… Tabla DynamoDB: ${TABLE_NAME}"
    echo "   âœ… GSI: estado-fecha_encendido-index"
    echo "   âœ… Bucket S3: ${BUCKET_NAME}"
    echo "   âœ… Archivo config: s3://${BUCKET_NAME}/config.json"
    echo "   âœ… Rol IAM: ${ROLE_NAME} (verificado)"
    echo ""
    echo "ðŸ”§ Variables de entorno para el deployment:"
    echo "   DYNAMODB_TABLE=${TABLE_NAME}"
    echo "   DYNAMODB_GSI_NAME=estado-fecha_encendido-index"
    echo "   S3_CONFIG_BUCKET=${BUCKET_NAME}"
    echo "   S3_CONFIG_KEY=config.json"
    echo ""
    echo "ðŸ“ PrÃ³ximos pasos:"
    echo "   1. Actualizar deployment.yaml con las variables de entorno"
    echo "   2. Verificar que el rol IAM tenga todos los permisos necesarios"
    echo "   3. Continuar con la implementaciÃ³n de la API"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: aws-infrastructure-setup
  namespace: encendido-eks
spec:
  template:
    spec:
      serviceAccountName: scaler-sa
      restartPolicy: Never
      containers:
      - name: aws-cli
        image: amazon/aws-cli:latest
        command: ["/bin/bash"]
        args: ["/scripts/create-infrastructure.sh"]
        env:
        - name: AWS_REGION
          value: "us-east-1"
        - name: ENVIRONMENT
          value: "prod"
        volumeMounts:
        - name: script-volume
          mountPath: /scripts
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      volumes:
      - name: script-volume
        configMap:
          name: aws-infrastructure-config
          defaultMode: 0755