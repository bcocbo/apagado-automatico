name: CI/CD Pipeline - Namespace Startup Scheduler

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_CONTROLLER: namespace-startup-scheduler-controller
  ECR_REPOSITORY_FRONTEND: namespace-startup-scheduler-frontend

permissions:
  id-token: write   # Required for OIDC
  contents: read    # Required for actions/checkout
  security-events: write  # Required for security scanning

jobs:
  lint-and-validate:
    name: Lint and Validate
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install Python linting tools
      run: |
        pip install black flake8 isort bandit safety
        
    - name: Lint Python code
      run: |
        cd controller
        black --check .
        flake8 .
        isort --check-only .
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Lint frontend code
      run: |
        cd frontend
        npm run lint
        
    - name: Validate YAML files
      run: |
        pip install yamllint
        yamllint .
        
    - name: Validate Kubernetes manifests
      run: |
        # Install kubeval
        curl -L https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz | tar xz
        sudo mv kubeval /usr/local/bin
        
        # Validate manifests
        find . -name "*.yaml" -path "*/infrastructure/*" -exec kubeval {} \;

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install security tools
      run: |
        pip install bandit safety
        
    - name: Run Bandit security scan
      run: |
        bandit -r controller/ -f sarif -o bandit-results.sarif || true
        
    - name: Upload Bandit results to GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: bandit-results.sarif
        
    - name: Run Safety dependency check
      run: |
        cd controller
        safety check --json --output ../safety-results.json || true
        
    - name: Run Trivy filesystem scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install Python dependencies
      run: |
        cd controller
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio
        
    - name: Run Python tests
      run: |
        cd controller
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=term-missing || echo "No tests found yet"
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Run frontend tests
      run: |
        cd frontend
        npm test -- --coverage --watchAll=false --passWithNoTests
        
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      if: always()
      with:
        files: ./controller/coverage.xml,./frontend/coverage/lcov.info
        fail_ci_if_error: false

  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    needs: [lint-and-validate, security-scan, test]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials using OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build and push controller image
      uses: docker/build-push-action@v5
      with:
        context: ./controller
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_CONTROLLER }}:${{ github.sha }}
          ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_CONTROLLER }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Build and push frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}:${{ github.sha }}
          ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Scan controller image with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_CONTROLLER }}:${{ github.sha }}
        format: 'sarif'
        output: 'controller-image-results.sarif'
        
    - name: Scan frontend image with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}:${{ github.sha }}
        format: 'sarif'
        output: 'frontend-image-results.sarif'
        
    - name: Upload controller image scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'controller-image-results.sarif'
        
    - name: Upload frontend image scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'frontend-image-results.sarif'

  deploy:
    name: Update Manifests for ArgoCD
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      
    - name: Update backend manifests
      run: |
        # Update backend image tag
        sed -i "s|CONTROLLER_IMAGE_TAG|${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_CONTROLLER }}:${{ github.sha }}|g" manifests/backend/deployment.yaml
        
    - name: Update frontend manifests
      run: |
        # Update frontend image tag
        sed -i "s|FRONTEND_IMAGE_TAG|${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}:${{ github.sha }}|g" manifests/frontend/deployment.yaml
        
    - name: Commit and push updated manifests
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add manifests/
        git diff --staged --quiet || git commit -m "Update image tags to ${{ github.sha }}"
        git push
        
    - name: Trigger ArgoCD sync (optional)
      run: |
        echo "Manifests updated. ArgoCD will automatically sync the changes."
        echo "Backend image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_CONTROLLER }}:${{ github.sha }}"
        echo "Frontend image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}:${{ github.sha }}"

  rollback:
    name: Rollback via ArgoCD
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure() && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Revert to previous commit
      run: |
        # Get the previous commit hash
        PREVIOUS_COMMIT=$(git rev-parse HEAD~1)
        
        # Revert manifest changes
        git checkout $PREVIOUS_COMMIT -- manifests/
        
        # Commit the revert
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add manifests/
        git commit -m "Rollback manifests due to deployment failure"
        git push
        
    - name: Notify rollback
      run: |
        echo "Deployment failed. Manifests reverted to previous version."
        echo "ArgoCD will automatically sync the rollback."
        # Add notification logic here (Slack, email, etc.)