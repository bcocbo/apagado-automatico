name: CI/CD para Apagado Automático

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write  # Para commit si actualizas manifests en el mismo repo
  id-token: write  # Para OIDC con AWS

env:
  AWS_REGION: us-east-1  # Ajusta a tu región
  ECR_REPOSITORY_SCALER: namespace/scaler  # Nombre de tu ECR repo para controlador
  ECR_REPOSITORY_FRONTEND: namespace/frontend  # Para frontend
  IMAGE_TAG: ${{ github.sha }}  # Tag único con commit SHA

jobs:
  validate-kyverno:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
      - name: Instalar Kyverno CLI
        run: |
          curl -LO "https://github.com/kyverno/kyverno/releases/download/v1.12.0/kyverno-cli_v1.12.0_linux_x86_64.tar.gz"
          tar -xzf kyverno-cli_v1.12.0_linux_x86_64.tar.gz
          sudo mv kyverno /usr/local/bin/kyverno
      - name: Validar políticas de Kyverno
        run: kyverno version  # Ajusta si tienes recursos de test; o usa 'kyverno test .'

  lint-yaml:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
     

  build-and-push-images:
    runs-on: ubuntu-latest
    needs: [validate-kyverno, lint-yaml]
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
      - name: Configurar AWS credentials con OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}  
          aws-region: ${{ env.AWS_REGION }}
        
      - name: Login a ECR
        uses: aws-actions/amazon-ecr-login@v2
      - name: Extract metadata scaler
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_SCALER }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}  

      - name: Build y push imagen controlador
        id: build-scaler
        uses: docker/build-push-action@v6
        with:
          context: controller
          push: true
          tags: ${{ steps.meta.outputs.tags }}

      - name: Extract metadata frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}    

      - name: Build y push imagen frontend
        id: build-frontend
        uses: docker/build-push-action@v6
        with:
          context: frontend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
      
      - name: Scan imágenes con Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_SCALER }}:${{ env.IMAGE_TAG }}
          format: table
          exit-code: 1  # Fallar si hay vulns críticas
          severity: CRITICAL,HIGH

  update-manifests:
    runs-on: ubuntu-latest
    needs: build-and-push-images
    if: github.ref == 'refs/heads/main'  # Solo en push a main
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
      - name: Actualizar tags en manifests
        run: |
          curl -sL https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o yq && chmod +x yq && sudo mv yq /usr/local/bin/
          yq e -i '.spec.template.spec.containers[0].image = "${{ secrets.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_SCALER }}:${{ env.IMAGE_TAG }}"' controller/deployment.yaml
          yq e -i '.spec.template.spec.containers[0].image = "${{ secrets.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY_FRONTEND }}:${{ env.IMAGE_TAG }}"' frontend/manifests.yaml
      - name: Commit y push cambios
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add controller/deployment.yaml frontend/manifests.yaml
          git commit -m "Actualiza imagenes a ${{ env.IMAGE_TAG }}" || echo "Sin cambios"
          git push

  