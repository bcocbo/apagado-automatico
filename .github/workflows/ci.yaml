name: CI/CD para Apagado Autom谩tico

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  id-token: write
  packages: write

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_SCALER: namespace-scaler
  ECR_REPOSITORY_FRONTEND: namespace-frontend
  IMAGE_TAG: ${{ github.sha }}

jobs:
  validate-kyverno:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c贸digo
        uses: actions/checkout@v4
        
      - name: Instalar Kyverno CLI
        run: |
          curl -LO "https://github.com/kyverno/kyverno/releases/download/v1.12.0/kyverno-cli_v1.12.0_linux_x86_64.tar.gz"
          tar -xzf kyverno-cli_v1.12.0_linux_x86_64.tar.gz
          sudo mv kyverno /usr/local/bin/kyverno
          
      - name: Validar pol铆ticas de Kyverno
        run: |
          kyverno version
          # Validar sintaxis de pol铆ticas
          find policies/ -name "*.yaml" -exec kyverno validate {} \;

  lint-yaml:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c贸digo
        uses: actions/checkout@v4
        
      - name: Instalar yamllint
        run: |
          pip install yamllint
          
      - name: Lint YAML files
        run: |
          yamllint -d relaxed .
          
      - name: Instalar kubeval
        run: |
          curl -LO https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin
          
      - name: Validar manifests de Kubernetes
        run: |
          find . -name "*.yaml" -path "*/k8s/*" -o -path "*/argocd/*" -o -path "*/controller/*" | xargs kubeval
     

  build-and-push-images:
    runs-on: ubuntu-latest
    needs: [validate-kyverno, lint-yaml]
    outputs:
      controller-image: ${{ steps.build-scaler.outputs.image }}
      frontend-image: ${{ steps.build-frontend.outputs.image }}
    steps:
      - name: Checkout c贸digo
        uses: actions/checkout@v4
        
      - name: Configurar AWS credentials con OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}
        
      - name: Login a ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        
      - name: Extract metadata scaler
        id: meta-scaler
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_SCALER }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build y push imagen controlador
        id: build-scaler
        uses: docker/build-push-action@v6
        with:
          context: controller
          push: true
          tags: ${{ steps.meta-scaler.outputs.tags }}
          labels: ${{ steps.meta-scaler.outputs.labels }}
          
      - name: Extract metadata frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build y push imagen frontend
        id: build-frontend
        uses: docker/build-push-action@v6
        with:
          context: frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
      
      - name: Scan imagen controlador con Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_SCALER }}:${{ env.IMAGE_TAG }}
          format: sarif
          output: trivy-controller-results.sarif
          
      - name: Scan imagen frontend con Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}:${{ env.IMAGE_TAG }}
          format: sarif
          output: trivy-frontend-results.sarif
          
      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-controller-results.sarif
          
      - name: Upload Trivy scan results frontend
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-frontend-results.sarif

  update-manifests:
    runs-on: ubuntu-latest
    needs: build-and-push-images
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout c贸digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Configurar Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
      - name: Instalar yq
        run: |
          curl -sL https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o yq
          chmod +x yq
          sudo mv yq /usr/local/bin/
          
      - name: Actualizar tags en manifests
        run: |
          # Actualizar imagen del controlador
          yq e -i '.spec.template.spec.containers[0].image = "${{ needs.build-and-push-images.outputs.controller-image }}"' controller/deployment.yaml
          
          # Crear manifest para frontend si no existe
          if [ ! -f "frontend/deployment.yaml" ]; then
            echo "Creando deployment.yaml para frontend..."
            cat > frontend/deployment.yaml << 'EOF'
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: namespace-frontend
            namespace: auto-shutdown
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: namespace-frontend
            template:
              metadata:
                labels:
                  app: namespace-frontend
              spec:
                containers:
                - name: frontend
                  image: placeholder
                  ports:
                  - containerPort: 8080
          EOF
          fi
          
          # Actualizar imagen del frontend
          yq e -i '.spec.template.spec.containers[0].image = "${{ needs.build-and-push-images.outputs.frontend-image }}"' frontend/deployment.yaml
          
      - name: Commit y push cambios
        run: |
          git add controller/deployment.yaml frontend/deployment.yaml
          if git diff --staged --quiet; then
            echo "No hay cambios para commitear"
          else
            git commit -m " Actualiza im谩genes a ${{ env.IMAGE_TAG }}"
            git push
          fi

  