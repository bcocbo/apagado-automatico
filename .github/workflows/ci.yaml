name: CI/CD para Apagado Autom치tico

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  contents: write
  id-token: write
  packages: write
  security-events: write

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_SCALER: namespace-scaler
  ECR_REPOSITORY_FRONTEND: namespace-frontend
  IMAGE_TAG: ${{ github.sha }}

jobs:
  validate-kyverno:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c칩digo
        uses: actions/checkout@v4

      - name: Instalar Kyverno CLI
        run: |
          curl -LO "https://github.com/kyverno/kyverno/releases/download/v1.12.0/kyverno-cli_v1.12.0_linux_x86_64.tar.gz"
          tar -xzf kyverno-cli_v1.12.0_linux_x86_64.tar.gz
          sudo mv kyverno /usr/local/bin/kyverno

      - name: Validar pol칤ticas de Kyverno
        run: |
          kyverno version
          # Validar sintaxis de pol칤ticas
          find policies/ -name "*.yaml" -exec kyverno validate {} \;

  lint-yaml:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c칩digo
        uses: actions/checkout@v4

      - name: Instalar yamllint
        run: |
          pip install yamllint

      - name: Lint YAML files
        run: |
          yamllint -d relaxed .

      - name: Instalar kubeval
        run: |
          curl -LO https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin

      - name: Validar manifests de Kubernetes
        run: |
          # Validar solo manifests YAML de Kubernetes, excluir Dockerfiles y ArgoCD CRDs
          find . -name "*.yaml" -type f \
            -not -path "*/argocd/*" \
            -not -path "*/.git/*" \
            -not -path "*/.github/*" \
            -not -name "Dockerfile*" \
            | xargs -r kubeval --ignore-missing-schemas

  build-and-push-images:
    runs-on: ubuntu-latest
    needs: [validate-kyverno, lint-yaml]
    outputs:
      controller-image: ${{ steps.build-scaler.outputs.image }}
      frontend-image: ${{ steps.build-frontend.outputs.image }}
    steps:
      - name: Checkout c칩digo
        uses: actions/checkout@v4

      - name: Configurar AWS credentials con OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login a ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Extract metadata scaler
        id: meta-scaler
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_SCALER }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build y push imagen controlador
        id: build-scaler
        uses: docker/build-push-action@v6
        with:
          context: controller
          push: true
          tags: ${{ steps.meta-scaler.outputs.tags }}
          labels: ${{ steps.meta-scaler.outputs.labels }}

      - name: Extract metadata frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build y push imagen frontend
        id: build-frontend
        uses: docker/build-push-action@v6
        with:
          context: frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}

      - name: Scan imagen controlador con Trivy
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_SCALER }}:${{ github.sha }}
          format: sarif
          output: trivy-controller-results.sarif

      - name: Scan imagen frontend con Trivy
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY_FRONTEND }}:${{ github.sha }}
          format: sarif
          output: trivy-frontend-results.sarif

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('trivy-controller-results.sarif') != ''
        with:
          sarif_file: trivy-controller-results.sarif

      - name: Upload Trivy scan results frontend
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('trivy-frontend-results.sarif') != ''
        with:
          sarif_file: trivy-frontend-results.sarif

  update-manifests:
    runs-on: ubuntu-latest
    needs: build-and-push-images
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout c칩digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Instalar yq
        run: |
          curl -sL https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o yq
          chmod +x yq
          sudo mv yq /usr/local/bin/

      - name: Configurar AWS credentials con OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login a ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Actualizar tags en manifests
        run: |
          # Construir las URLs de las im치genes usando el registry ECR conocido
          ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          CONTROLLER_IMAGE="${ECR_REGISTRY}/${{ env.ECR_REPOSITORY_SCALER }}:${{ github.sha }}"
          FRONTEND_IMAGE="${ECR_REGISTRY}/${{ env.ECR_REPOSITORY_FRONTEND }}:${{ github.sha }}"
          #
          echo "Actualizando im치genes:"
          echo "Controller: $CONTROLLER_IMAGE"
          echo "Frontend: $FRONTEND_IMAGE"
          #
          # Actualizar imagen del controlador
          yq e -i '.spec.template.spec.containers[0].image = "'$CONTROLLER_IMAGE'"' controller/deployment.yaml
          #
          # Actualizar imagen del frontend
          yq e -i '.spec.template.spec.containers[0].image = "'$FRONTEND_IMAGE'"' frontend/deployment.yaml
          #
          # Verificar cambios
          echo "=== Controller deployment ==="
          grep -A 2 -B 2 "image:" controller/deployment.yaml
          echo "=== Frontend deployment ==="
          grep -A 2 -B 2 "image:" frontend/deployment.yaml

      - name: Commit y push cambios
        run: |
          git add controller/deployment.yaml frontend/deployment.yaml
          if git diff --staged --quiet; then
            echo "No hay cambios para commitear"
          else
            git commit -m "游 Actualiza im치genes a ${{ env.IMAGE_TAG }}"
            git push
          fi
