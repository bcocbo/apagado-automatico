apiVersion: v1
kind: ServiceAccount
metadata:
  name: kubectl-runner
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::226633502530:role/kubectl-runner-role
---
# ClusterRole con permisos de solo lectura a nivel de cluster
# Este role se usa en namespaces protegidos para prevenir modificaciones
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kubectl-runner-readonly
rules:
# Permisos para listar y ver namespaces (necesario para descubrir namespaces)
- apiGroups: [""]
  resources: ["namespaces"]
  verbs: ["get", "list", "watch"]

# Permisos de solo lectura para pods a nivel de cluster
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]

# Permisos de solo lectura para pods con field selectors (para status checks)
- apiGroups: [""]
  resources: ["pods/status"]
  verbs: ["get", "list"]

# Permisos de solo lectura para deployments, statefulsets, etc.
- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets", "daemonsets", "replicasets"]
  verbs: ["get", "list", "watch"]

# Permisos de solo lectura para métricas (opcional)
- apiGroups: ["metrics.k8s.io"]
  resources: ["pods", "nodes"]
  verbs: ["get", "list"]
---
# ClusterRole con permisos de escritura para escalar recursos
# Este role se usa en namespaces NO protegidos mediante ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kubectl-runner-scale
rules:
# Permisos para listar y ver namespaces
- apiGroups: [""]
  resources: ["namespaces"]
  verbs: ["get", "list", "watch"]

# Permisos para ver pods y su estado
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]

# Permisos para ver estado de pods (necesario para field selectors)
- apiGroups: [""]
  resources: ["pods/status"]
  verbs: ["get", "list"]

# Permisos para escalar deployments, statefulsets y daemonsets
- apiGroups: ["apps"]
  resources: ["deployments", "statefulsets", "daemonsets", "replicasets"]
  verbs: ["get", "list", "watch", "patch", "update"]

# Permisos para escalar usando el subrecurso scale (método recomendado)
- apiGroups: ["apps"]
  resources: ["deployments/scale", "statefulsets/scale", "replicasets/scale"]
  verbs: ["get", "patch", "update"]

# Permisos para recursos de extensiones (compatibilidad con versiones antiguas)
- apiGroups: ["extensions"]
  resources: ["deployments", "replicasets"]
  verbs: ["get", "list", "watch", "patch", "update"]

- apiGroups: ["extensions"]
  resources: ["deployments/scale", "replicasets/scale"]
  verbs: ["get", "patch", "update"]

# Permisos de solo lectura para métricas (opcional)
- apiGroups: ["metrics.k8s.io"]
  resources: ["pods", "nodes"]
  verbs: ["get", "list"]
---
# ClusterRoleBinding para permisos de solo lectura a nivel global
# Este binding permite al service account ver recursos en todos los namespaces
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kubectl-runner-readonly
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kubectl-runner-readonly
subjects:
- kind: ServiceAccount
  name: kubectl-runner
  namespace: task-scheduler  # ClusterRoleBindings need explicit namespace
---
# RoleBindings en namespaces protegidos (SOLO LECTURA)
# Estos RoleBindings sobrescriben el ClusterRoleBinding de scale en namespaces críticos
# Los namespaces protegidos NO pueden ser escalados para prevenir interrupciones del sistema

# RoleBinding en kube-system (SOLO LECTURA - protegido)
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: kubectl-runner-readonly
  namespace: kube-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kubectl-runner-readonly
subjects:
- kind: ServiceAccount
  name: kubectl-runner
  namespace: task-scheduler
---
# RoleBinding en argocd (SOLO LECTURA - protegido)
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: kubectl-runner-readonly
  namespace: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kubectl-runner-readonly
subjects:
- kind: ServiceAccount
  name: kubectl-runner
  namespace: task-scheduler
---
# RoleBinding en istio-system (SOLO LECTURA - protegido)
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: kubectl-runner-readonly
  namespace: istio-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kubectl-runner-readonly
subjects:
- kind: ServiceAccount
  name: kubectl-runner
  namespace: task-scheduler
---
# RoleBinding en kyverno (SOLO LECTURA - protegido)
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: kubectl-runner-readonly
  namespace: kyverno
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kubectl-runner-readonly
subjects:
- kind: ServiceAccount
  name: kubectl-runner
  namespace: task-scheduler
---
# RoleBinding en task-scheduler (SOLO LECTURA - protegido)
# Note: namespace will be added by kustomization.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: kubectl-runner-readonly-self
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kubectl-runner-readonly
subjects:
- kind: ServiceAccount
  name: kubectl-runner
---
# RoleBinding en kube-public (SOLO LECTURA - protegido)
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: kubectl-runner-readonly
  namespace: kube-public
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kubectl-runner-readonly
subjects:
- kind: ServiceAccount
  name: kubectl-runner
  namespace: task-scheduler
---
# RoleBinding en kube-node-lease (SOLO LECTURA - protegido)
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: kubectl-runner-readonly
  namespace: kube-node-lease
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kubectl-runner-readonly
subjects:
- kind: ServiceAccount
  name: kubectl-runner
  namespace: task-scheduler
---
# RoleBinding en karpenter (SOLO LECTURA - protegido)
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: kubectl-runner-readonly
  namespace: karpenter
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kubectl-runner-readonly
subjects:
- kind: ServiceAccount
  name: kubectl-runner
  namespace: task-scheduler
---
# RoleBinding en keda (SOLO LECTURA - protegido)
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: kubectl-runner-readonly
  namespace: keda
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kubectl-runner-readonly
subjects:
- kind: ServiceAccount
  name: kubectl-runner
  namespace: task-scheduler
---
# RoleBinding en vision (SOLO LECTURA - protegido)
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: kubectl-runner-readonly
  namespace: vision
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kubectl-runner-readonly
subjects:
- kind: ServiceAccount
  name: kubectl-runner
  namespace: task-scheduler
---
# ClusterRoleBinding para permisos de scale en todos los namespaces
# (excepto los protegidos que tienen RoleBindings de solo lectura)
# Los namespaces protegidos son: kube-system, kube-public, kube-node-lease, 
# argocd, istio-system, kyverno, task-scheduler, karpenter, keda, vision
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kubectl-runner-scale
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kubectl-runner-scale
subjects:
- kind: ServiceAccount
  name: kubectl-runner
  namespace: task-scheduler  # ClusterRoleBindings need explicit namespace
