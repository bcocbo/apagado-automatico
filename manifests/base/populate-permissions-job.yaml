apiVersion: batch/v1
kind: Job
metadata:
  name: populate-cost-center-permissions
  namespace: task-scheduler
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app: populate-permissions
    spec:
      serviceAccountName: kubectl-runner
      restartPolicy: Never
      containers:
      - name: populate-permissions
        image: python:3.11-slim
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "ðŸ“¦ Instalando dependencias..."
          pip install boto3 --quiet
          
          echo "ðŸ“ Creando script de poblaciÃ³n..."
          cat > /tmp/populate.py << 'EOFSCRIPT'
          #!/usr/bin/env python3
          import boto3
          import sys
          import time
          from botocore.exceptions import ClientError

          def populate_cost_center_permissions(environment='production'):
              dynamodb = boto3.resource('dynamodb')
              table_name = f'cost-center-permissions-{environment}'
              
              try:
                  table = dynamodb.Table(table_name)
                  table.load()
                  print(f"ðŸ“‹ Poblando tabla: {table_name}")
                  
                  initial_cost_centers = [
                      {
                          'cost_center': 'IT-DEVELOPMENT',
                          'codigo-cost-center': 'C102000001',
                          'is_authorized': True,
                          'max_concurrent_namespaces': 10,
                          'authorized_namespaces': ['dev-*', 'test-*', 'staging-*'],
                          'description': 'Centro de costo para desarrollo de TI'
                      },
                      {
                          'cost_center': 'IT-PRODUCTION',
                          'codigo-cost-center': 'C102000002',
                          'is_authorized': True,
                          'max_concurrent_namespaces': 5,
                          'authorized_namespaces': ['prod-*', 'production-*'],
                          'description': 'Centro de costo para producciÃ³n de TI'
                      },
                      {
                          'cost_center': 'QA-TESTING',
                          'codigo-cost-center': 'C102000003',
                          'is_authorized': True,
                          'max_concurrent_namespaces': 8,
                          'authorized_namespaces': ['qa-*', 'test-*', 'e2e-*'],
                          'description': 'Centro de costo para testing y QA'
                      },
                      {
                          'cost_center': 'DEVOPS-INFRA',
                          'codigo-cost-center': 'C102000004',
                          'is_authorized': True,
                          'max_concurrent_namespaces': 15,
                          'authorized_namespaces': ['*'],
                          'description': 'Centro de costo para infraestructura DevOps'
                      },
                      {
                          'cost_center': 'DEMO-SANDBOX',
                          'codigo-cost-center': 'C102000005',
                          'is_authorized': True,
                          'max_concurrent_namespaces': 3,
                          'authorized_namespaces': ['demo-*', 'sandbox-*'],
                          'description': 'Centro de costo para demos y sandbox'
                      },
                      {
                          'cost_center': 'EXTERNAL-CONTRACTOR',
                          'codigo-cost-center': 'C102000006',
                          'is_authorized': False,
                          'max_concurrent_namespaces': 2,
                          'authorized_namespaces': ['contractor-*'],
                          'description': 'Centro de costo para contratistas externos (deshabilitado por defecto)'
                      }
                  ]
                  
                  for cost_center_data in initial_cost_centers:
                      cost_center_data['created_at'] = int(time.time())
                      cost_center_data['updated_at'] = int(time.time())
                      
                      try:
                          table.put_item(
                              Item=cost_center_data,
                              ConditionExpression='attribute_not_exists(cost_center)'
                          )
                          status = "âœ… Creado"
                      except ClientError as e:
                          if e.response['Error']['Code'] == 'ConditionalCheckFailedException':
                              status = "âš ï¸  Ya existe"
                          else:
                              raise e
                      
                      print(f"   {status}: {cost_center_data['cost_center']} - {cost_center_data['description']}")
                  
                  print(f"\nðŸ“Š Resumen de centros de costo:")
                  response = table.scan()
                  items = response['Items']
                  
                  print(f"   Total de centros de costo: {len(items)}")
                  print(f"   Autorizados: {len([item for item in items if item.get('is_authorized', False)])}")
                  print(f"   No autorizados: {len([item for item in items if not item.get('is_authorized', False)])}")
                  
                  print(f"\nðŸ” Detalle de centros de costo:")
                  for item in sorted(items, key=lambda x: x['cost_center']):
                      auth_status = "âœ… Autorizado" if item.get('is_authorized', False) else "âŒ No autorizado"
                      max_ns = item.get('max_concurrent_namespaces', 0)
                      namespaces = ', '.join(item.get('authorized_namespaces', []))
                      print(f"   {item['cost_center']}: {auth_status}, Max NS: {max_ns}, Patrones: [{namespaces}]")
                  
                  return len(items)
                  
              except ClientError as e:
                  if e.response['Error']['Code'] == 'ResourceNotFoundException':
                      print(f"âŒ Error: La tabla {table_name} no existe")
                      sys.exit(1)
                  else:
                      print(f"âŒ Error accediendo a la tabla: {e}")
                      sys.exit(1)
              except Exception as e:
                  print(f"âŒ Error inesperado: {e}")
                  sys.exit(1)

          if __name__ == '__main__':
              try:
                  sts = boto3.client('sts')
                  identity = sts.get_caller_identity()
                  print(f"ðŸ” Usando credenciales AWS para: {identity.get('Arn', 'N/A')}")
              except Exception as e:
                  print(f"âŒ Error: No se pudieron obtener las credenciales de AWS: {e}")
                  sys.exit(1)
              
              count = populate_cost_center_permissions('production')
              print(f"\nâœ¨ Proceso completado. {count} centros de costo configurados.")
          EOFSCRIPT
          
          echo "ðŸš€ Ejecutando script de poblaciÃ³n..."
          python /tmp/populate.py
        env:
        - name: AWS_REGION
          value: "us-east-1"
        - name: AWS_DEFAULT_REGION
          value: "us-east-1"
